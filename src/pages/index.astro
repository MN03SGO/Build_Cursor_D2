---
import Layout from '../layouts/Layout.astro';
---
<Layout title="Inicio - MentorAI">
  <section class="hero">
    <div class="hero-copy fade-up">
      <span class="pill">Nuevo · IA para estudio</span>
      <h1>MentorAI</h1>
      <p>
        Organiza tus materias, planifica tu semana y genera planes de estudio con
        inteligencia artificial en segundos.
      </p>
      <div class="hero-actions" id="hero-actions">
        <button type="button" class="btn btn-primary" data-modal="modal-registro" data-auth="guest">Crear cuenta</button>
        <button type="button" class="btn btn-outline" data-modal="modal-login" data-auth="guest">Ingresar</button>
        <a class="btn btn-primary" href="/dashboard" data-auth="user">Ir al dashboard</a>
      </div>
    </div>
  </section>

  <!-- Modal Crear cuenta -->
  <div class="modal-overlay" id="modal-registro" aria-hidden="true" role="dialog" aria-labelledby="modal-registro-title">
    <div class="modal-box">
      <div class="modal-inner">
        <h2 class="modal-title" id="modal-registro-title">Crear cuenta</h2>
        <form class="modal-form form-registro-modal" id="form-registro-modal">
          <div class="form-group">
            <label for="modal-nombre">Nombre completo</label>
            <input type="text" id="modal-nombre" name="nombre" required placeholder="Ej: Ana López" />
          </div>
          <div class="form-group">
            <label for="modal-email-reg">Correo</label>
            <input type="email" id="modal-email-reg" name="email" required placeholder="correo@ejemplo.com" />
          </div>
          <div class="form-group">
            <label for="modal-password-reg">Contraseña</label>
            <input type="password" id="modal-password-reg" name="password" required />
          </div>
          <button type="submit" class="btn btn-primary btn-submit">Crear cuenta</button>
          <div class="form-divider"><span>o</span></div>
          <button type="button" class="btn btn-github" id="btn-registro-github-modal" aria-label="Registrarse con GitHub">
            <svg class="btn-github-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
            Registrarse con GitHub
          </button>
          <p class="form-status" id="form-status-registro" aria-live="polite"></p>
        </form>
        <button type="button" class="modal-close" data-close="modal-registro" aria-label="Cerrar">×</button>
      </div>
    </div>
  </div>

  <!-- Modal Ingresar -->
  <div class="modal-overlay" id="modal-login" aria-hidden="true" role="dialog" aria-labelledby="modal-login-title">
    <div class="modal-box">
      <div class="modal-inner">
        <h2 class="modal-title" id="modal-login-title">Iniciar sesión</h2>
        <form class="modal-form form-login-modal" id="form-login-modal">
          <div class="form-group">
            <label for="modal-email-login">Correo</label>
            <input type="email" id="modal-email-login" name="email" required placeholder="correo@ejemplo.com" />
          </div>
          <div class="form-group">
            <label for="modal-password-login">Contraseña</label>
            <input type="password" id="modal-password-login" name="password" required />
          </div>
          <button type="submit" class="btn btn-primary btn-submit">Ingresar</button>
          <div class="form-divider"><span>o</span></div>
          <button type="button" class="btn btn-github" id="btn-login-github-modal" aria-label="Iniciar sesión con GitHub">
            <svg class="btn-github-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
            Iniciar sesión con GitHub
          </button>
          <p class="form-link-forgot">
            <a href="#" id="link-olvide-modal" class="link-forgot">¿Olvidé mi contraseña?</a>
          </p>
          <p class="form-status" id="form-status-login" aria-live="polite"></p>
        </form>
        <button type="button" class="modal-close" data-close="modal-login" aria-label="Cerrar">×</button>
      </div>
    </div>
  </div>

  <section class="features">
    <article class="hero-card card feature-card fade-up">
      <h2 class="section-title">Todo lo que puedes hacer</h2>
      <ul class="feature-list">
        <li>Registrar materias y fechas de exámenes.</li>
        <li>Generar planes de estudio personalizados.</li>
        <li>Acceder a funciones premium con más detalle.</li>
        <li>Consultar tu progreso diario.</li>
      </ul>
    </article>
    <article class="feature-card card fade-up">
      <h3>Plan diario</h3>
      <p>Visualiza tus tareas del día con recordatorios y prioridades.</p>
      <ul class="feature-list">
        <li>Checklist interactiva</li>
        <li>Orden por horario</li>
        <li>Indicadores de avance</li>
      </ul>
    </article>
    <article class="feature-card card fade-up">
      <h3>IA para estudio</h3>
      <p>Recibe planes guiados y preguntas de repaso según tu nivel.</p>
      <ul class="feature-list">
        <li>Planes por semanas</li>
        <li>Mini-proyectos</li>
        <li>Quizzes rápidos</li>
      </ul>
    </article>
    <article class="feature-card card fade-up">
      <h3>Premium</h3>
      <p>Obtén respuestas expertas, más profundidad y acceso extendido.</p>
      <ul class="feature-list">
        <li>Nivel experto</li>
        <li>Más preguntas</li>
        <li>Profundidad avanzada</li>
      </ul>
    </article>
  </section>
</Layout>

<style>
  .hero {
    margin-bottom: 2.5rem;
  }
  .hero-copy {
    max-width: 520px;
    margin: 0 auto;
    text-align: center;
  }
  .hero-copy p {
    color: var(--text-muted);
    line-height: 1.6;
  }
  .hero-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-top: 1.5rem;
    justify-content: center;
  }
  .features {
    display: grid;
    gap: 1.25rem;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  }
  .hero-card.feature-card {
    padding: 1.5rem;
    border: 1px solid rgba(74, 144, 217, 0.12);
    background: linear-gradient(160deg, rgba(74, 144, 217, 0.08), rgba(255, 255, 255, 0.02));
  }
  .hero-card.feature-card h2 {
    margin-top: 0;
  }
  .hero-card .feature-list {
    margin: 0.75rem 0 0;
    padding-left: 1.2rem;
    color: var(--text-muted);
  }
  .feature-card {
    padding: 1.5rem;
    border: 1px solid rgba(74, 144, 217, 0.08);
    background: rgba(255, 255, 255, 0.04);
  }
  .feature-card p {
    color: var(--text-muted);
  }
  .feature-list {
    margin: 0.75rem 0 0;
    padding-left: 1.2rem;
    color: var(--text-muted);
  }
  .feature-card h3 {
    margin-top: 0;
  }
  .feature-card:hover {
    transform: translateY(-6px);
  }

  /* Ventanas flotantes (modales) */
  .modal-overlay {
    position: fixed;
    inset: 0;
    z-index: 100;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease, visibility 0.2s ease;
  }

  .modal-overlay[aria-hidden="false"] {
    opacity: 1;
    visibility: visible;
  }

  .modal-box {
    width: 100%;
    max-width: 420px;
    max-height: 90vh;
    overflow-y: auto;
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow-lg);
    position: relative;
  }

  .modal-inner {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: clamp(1.25rem, 4vw, 2rem);
    text-align: center;
  }

  .modal-title {
    margin: 0 0 1.25rem;
    font-size: 1.35rem;
    color: var(--text);
    width: 100%;
  }

  .modal-form {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .modal-form .form-group {
    width: 100%;
    max-width: 100%;
    text-align: left;
  }

  .modal-form .form-group label {
    display: block;
  }

  .modal-form .btn-submit {
    width: 100%;
    margin-top: 0.5rem;
  }

  .modal-form .form-link-forgot {
    margin: 0.75rem 0 0;
    width: 100%;
    text-align: center;
  }

  .modal-form .link-forgot {
    color: var(--accent);
    font-size: 0.9rem;
    font-weight: 600;
    text-decoration: none;
  }

  .modal-form .link-forgot:hover {
    text-decoration: underline;
  }

  .modal-form .form-status {
    margin: 0.75rem 0 0;
    color: var(--text-muted);
    min-height: 1.2rem;
    width: 100%;
    text-align: center;
  }

  .modal-close {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    width: 36px;
    height: 36px;
    padding: 0;
    border: none;
    background: transparent;
    font-size: 1.75rem;
    line-height: 1;
    color: var(--text-muted);
    cursor: pointer;
    -webkit-appearance: none;
    appearance: none;
    border-radius: 8px;
    transition: background 0.2s, color 0.2s;
  }

  .modal-close:hover {
    background: rgba(0, 0, 0, 0.06);
    color: var(--text);
  }

  .form-divider {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin: 1rem 0;
    color: var(--text-muted);
    font-size: 0.9rem;
  }
  .form-divider::before,
  .form-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: rgba(0, 0, 0, 0.12);
  }
  .btn-github {
    width: 100%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    font-weight: 600;
    color: #24292f;
    background: #fff;
    border: 1px solid rgba(27, 31, 36, 0.15);
    border-radius: var(--radius);
    cursor: pointer;
    transition: background 0.2s, border-color 0.2s;
  }
  .btn-github:hover {
    background: #f6f8fa;
    border-color: rgba(27, 31, 36, 0.25);
  }
  .btn-github-icon {
    width: 1.25rem;
    height: 1.25rem;
  }

  @media (max-width: 479px) {
    .modal-inner {
      padding: 1.25rem;
    }
  }
</style>

<script>
  import { createClient } from '@supabase/supabase-js';

  function initGitHubOAuth(btnId: string, statusId: string) {
    const btn = document.getElementById(btnId);
    const statusEl = document.getElementById(statusId);
    if (!btn || !statusEl) return;
    btn.addEventListener('click', async () => {
      const url = import.meta.env.PUBLIC_SUPABASE_URL;
      const key = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
      if (!url || !key) {
        statusEl.textContent = 'Login con GitHub no configurado. Añade PUBLIC_SUPABASE_URL y PUBLIC_SUPABASE_ANON_KEY.';
        return;
      }
      statusEl.textContent = 'Redirigiendo a GitHub...';
      try {
        const supabase = createClient(url, key);
        const redirectTo = `${window.location.origin}/auth/callback`;
        const { data, error } = await supabase.auth.signInWithOAuth({
          provider: 'github',
          options: { redirectTo }
        });
        if (error) throw error;
        if (data?.url) window.location.href = data.url;
        else statusEl.textContent = 'No se pudo obtener la URL de GitHub.';
      } catch (err) {
        statusEl.textContent = (err as Error)?.message || 'Error al conectar con GitHub.';
      }
    });
  }

  const isLoggedIn = Boolean(localStorage.getItem('userSession'));
  document.querySelectorAll('[data-auth="guest"]').forEach((el) => {
    (el as HTMLElement).style.display = isLoggedIn ? 'none' : 'inline-flex';
  });
  document.querySelectorAll('[data-auth="user"]').forEach((el) => {
    (el as HTMLElement).style.display = isLoggedIn ? 'inline-flex' : 'none';
  });

  // Abrir modal
  document.querySelectorAll('[data-modal]').forEach((btn) => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const id = (btn as HTMLElement).getAttribute('data-modal');
      const modal = id ? document.getElementById(id) : null;
      if (modal) {
        modal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
        (modal.querySelector('input') as HTMLInputElement)?.focus();
      }
    });
  });

  function closeModal(id: string) {
    const modal = document.getElementById(id);
    if (modal) {
      modal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
    }
  }

  // Cerrar con botón
  document.querySelectorAll('[data-close]').forEach((btn) => {
    btn.addEventListener('click', () => {
      const id = (btn as HTMLElement).getAttribute('data-close');
      if (id) closeModal(id);
    });
  });

  // Cerrar al hacer clic en el overlay (no en el contenido)
  document.querySelectorAll('.modal-overlay').forEach((overlay) => {
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) closeModal(overlay.id);
    });
  });

  // Cerrar con Escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      document.querySelectorAll('.modal-overlay[aria-hidden="false"]').forEach((m) => closeModal(m.id));
    }
  });

  // Formulario Crear cuenta (modal)
  document.getElementById('form-registro-modal')?.addEventListener('submit', (e) => {
    e.preventDefault();
    const form = e.target as HTMLFormElement;
    const nombre = (form.nombre as HTMLInputElement).value.trim();
    const email = (form.email as HTMLInputElement).value.trim();
    const password = (form.password as HTMLInputElement).value;
    const statusEl = document.getElementById('form-status-registro');
    if (!nombre || !email || !password || !statusEl) return;

    statusEl.textContent = 'Creando cuenta...';

    fetch('/api/auth/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ nombre, email, password })
    })
      .then(async (res) => {
        if (!res.ok) throw new Error(await res.text());
        return res.json();
      })
      .then((data) => {
        localStorage.setItem('userSession', JSON.stringify(data));
        closeModal('modal-registro');
        window.location.href = '/dashboard';
      })
      .catch((err) => {
        statusEl.textContent = err?.message || 'No se pudo crear la cuenta.';
      });
  });

  initGitHubOAuth('btn-registro-github-modal', 'form-status-registro');
  initGitHubOAuth('btn-login-github-modal', 'form-status-login');

  // ¿Olvidé mi contraseña? (modal)
  document.getElementById('link-olvide-modal')?.addEventListener('click', (e) => {
    e.preventDefault();
    const statusEl = document.getElementById('form-status-login');
    if (statusEl) statusEl.textContent = 'Próximamente: recuperar contraseña por correo.';
  });

  // Formulario Ingresar (modal)
  document.getElementById('form-login-modal')?.addEventListener('submit', (e) => {
    e.preventDefault();
    const form = e.target as HTMLFormElement;
    const email = (form.email as HTMLInputElement).value.trim();
    const password = (form.password as HTMLInputElement).value;
    const statusEl = document.getElementById('form-status-login');
    if (!email || !password || !statusEl) return;

    statusEl.textContent = 'Validando acceso...';

    fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    })
      .then(async (res) => {
        if (!res.ok) throw new Error(await res.text());
        return res.json();
      })
      .then((data) => {
        localStorage.setItem('userSession', JSON.stringify(data));
        closeModal('modal-login');
        window.location.href = '/dashboard';
      })
      .catch((err) => {
        statusEl.textContent = err?.message || 'No se pudo iniciar sesión.';
      });
  });
</script>
