---
import '../styles/global.css';
import Analytics from '@vercel/analytics/astro';

interface Props {
  title?: string;
}
const { title = 'MentorAI' } = Astro.props;
---
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="theme-color" content="#ffffff" />
    <title>{title}</title>
    <Analytics />
  </head>
  <body>
    <header class="header">
      <a href="/" class="header-title">MentorAI</a>
      <button type="button" class="nav-toggle" id="nav-toggle" aria-label="Abrir menÃº" aria-expanded="false" aria-controls="main-nav">
        <span class="nav-toggle-bar"></span>
        <span class="nav-toggle-bar"></span>
        <span class="nav-toggle-bar"></span>
      </button>
      <nav class="nav" id="main-nav" aria-label="NavegaciÃ³n principal">
        <a href="/">Inicio</a>
        <a href="/dashboard" data-auth="user">Dashboard</a>
        
        <a href="/premium">Premium</a>
        <a href="/login" data-auth="guest">Ingresar</a>
        <a href="/registro" data-auth="guest">Registro</a>
        <span class="user-pill" id="user-pill" data-auth="user"></span>
        <button type="button" class="btn btn-outline btn-logout" id="logout-btn" data-auth="user">
          Cerrar sesiÃ³n
        </button>
      </nav>
    </header>
    <main class="main">
      <slot />
    </main>
    <div class="chat-float-wrap" id="chat-float-wrap" data-auth="user">
      <button type="button" class="chat-fab" id="chat-fab" aria-label="Abrir chat IA">
        ðŸ’¬
      </button>
      <section class="chat-panel" id="chat-panel" aria-live="polite">
        <header class="chat-header">
          <h3>Chat IA</h3>
          <button type="button" class="chat-close" id="chat-close" aria-label="Cerrar chat">âœ•</button>
        </header>
        <div class="chat-messages" id="chat-messages"></div>
        <form class="chat-form" id="chat-form">
          <input type="text" id="chat-input" placeholder="Escribe tu pregunta..." required />
          <button type="submit" class="btn btn-primary">Enviar</button>
        </form>
      </section>
    </div>
  </body>
</html>

<script is:inline>
  document.addEventListener('DOMContentLoaded', function() {
    var toggle = document.getElementById('nav-toggle');
    var nav = document.getElementById('main-nav');
    if (toggle && nav) {
      function openMenu() {
        nav.classList.add('nav--open');
        toggle.setAttribute('aria-expanded', 'true');
        toggle.setAttribute('aria-label', 'Cerrar menÃº');
      }
      function closeMenu() {
        nav.classList.remove('nav--open');
        toggle.setAttribute('aria-expanded', 'false');
        toggle.setAttribute('aria-label', 'Abrir menÃº');
      }
      toggle.addEventListener('click', function() {
        if (nav.classList.contains('nav--open')) closeMenu(); else openMenu();
      });
      nav.querySelectorAll('a').forEach(function(link) {
        link.addEventListener('click', closeMenu);
      });
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeMenu();
      });
    }
  });
</script>

<script>
  const logoutBtn = document.getElementById('logout-btn');
  const userPill = document.getElementById('user-pill');
  const sessionRaw = localStorage.getItem('userSession');
  let session = null;
  try {
    session = sessionRaw ? JSON.parse(sessionRaw) : null;
  } catch {
    session = null;
  }
  const isLoggedIn = Boolean(session);

  document.querySelectorAll('[data-auth="guest"]').forEach((el) => {
    (el as HTMLElement).style.display = isLoggedIn ? 'none' : 'inline-flex';
  });
  document.querySelectorAll('[data-auth="user"]').forEach((el) => {
    const element = el as HTMLElement;
    if (!isLoggedIn) {
      element.style.display = 'none';
      return;
    }
    if (element.classList.contains('chat-float-wrap')) {
      element.style.display = 'block';
      return;
    }
    element.style.display = 'inline-flex';
  });
  if (userPill && session?.nombre) {
    userPill.textContent = `Hola, ${session.nombre}`;
  }

  logoutBtn?.addEventListener('click', () => {
    localStorage.removeItem('userSession');
    window.location.href = '/';
  });
</script>

<script>
  const chatFab = document.getElementById('chat-fab');
  const chatPanel = document.getElementById('chat-panel');
  const chatClose = document.getElementById('chat-close');
  const chatForm = document.getElementById('chat-form');
  const chatInput = document.getElementById('chat-input');
  const chatMessages = document.getElementById('chat-messages');

  function appendMessage(text, type) {
    if (!chatMessages) return;
    const div = document.createElement('div');
    div.className = `chat-message ${type}`;
    div.textContent = text;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Solo se abre con click
  chatFab?.addEventListener('click', (e) => {
    e.stopPropagation();
    chatPanel?.classList.toggle('open');
    if (chatPanel?.classList.contains('open')) chatInput?.focus();
  });
  chatClose?.addEventListener('click', () => {
    chatPanel?.classList.remove('open');
  });

  chatForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!chatInput || !chatMessages) return;
    const message = chatInput.value.trim();
    if (!message) return;

    appendMessage(message, 'user');
    chatInput.value = '';
    appendMessage('Pensando...', 'assistant pending');

    const sessionRaw = localStorage.getItem('userSession');
    const session = sessionRaw ? JSON.parse(sessionRaw) : null;
    const plan = session?.plan === 'premium' ? 'premium' : 'free';

    try {
      const res = await fetch('/api/ai/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message, plan })
      });
      const text = await res.text();
      let data = null;
      try {
        data = JSON.parse(text);
      } catch {
        data = null;
      }
      if (!res.ok) {
        const errMsg = data?.error || text || 'Error';
        throw new Error(errMsg);
      }

      const last = chatMessages.querySelector('.chat-message.assistant.pending');
      if (last) last.remove();
      appendMessage(data?.reply || 'No hay respuesta.', 'assistant');
    } catch (err) {
      const last = chatMessages.querySelector('.chat-message.assistant.pending');
      if (last) last.remove();
      appendMessage(
        err instanceof Error ? `No se pudo responder: ${err.message}` : 'No se pudo responder.',
        'assistant'
      );
    }
  });
</script>

<style>
  .btn-logout {
    padding: 0.45rem 1rem;
    min-height: auto;
  }
  .user-pill {
    display: inline-flex;
    align-items: center;
    padding: 0.35rem 0.7rem;
    border-radius: 999px;
    background: rgba(74, 144, 217, 0.12);
    color: var(--accent);
    font-weight: 600;
    font-size: 0.85rem;
  }
  .chat-float-wrap {
    position: fixed;
    right: 1.5rem;
    bottom: 1.5rem;
    z-index: 30;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.5rem;
  }
  .chat-fab {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: var(--accent);
    color: white;
    border: none;
    cursor: pointer;
    font-size: 1.35rem;
    box-shadow: var(--shadow-lg);
    flex-shrink: 0;
  }
  .chat-fab:hover {
    background: var(--accent-hover);
  }
  .chat-panel {
    width: min(360px, 90vw);
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow-lg);
    display: none;
    flex-direction: column;
    overflow: hidden;
    max-height: 0;
    opacity: 0;
    pointer-events: none;
    transition: max-height 0.2s ease, opacity 0.2s ease;
  }
  .chat-panel.open {
    display: flex;
    max-height: 90vh;
    opacity: 1;
    pointer-events: auto;
  }
  .chat-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    background: rgba(74, 144, 217, 0.1);
  }
  .chat-header h3 {
    margin: 0;
    font-size: 1rem;
  }
  .chat-close {
    border: none;
    background: transparent;
    font-size: 1.1rem;
    cursor: pointer;
  }
  .chat-messages {
    padding: 1rem;
    display: grid;
    gap: 0.75rem;
    max-height: 320px;
    overflow-y: auto;
  }
  .chat-message {
    padding: 0.65rem 0.8rem;
    border-radius: 12px;
    font-size: 0.95rem;
  }
  .chat-message.user {
    background: rgba(74, 144, 217, 0.12);
    justify-self: end;
  }
  .chat-message.assistant {
    background: #f6f7fb;
    border: 1px solid #eee;
  }
  .chat-message.assistant.pending {
    opacity: 0.7;
  }
  .chat-form {
    display: flex;
    gap: 0.5rem;
    padding: 0.75rem;
    border-top: 1px solid #eee;
  }
  .chat-form input {
    flex: 1;
    padding: 0.6rem 0.8rem;
    border-radius: 10px;
    border: 1px solid #ddd;
    font: inherit;
  }
</style>
